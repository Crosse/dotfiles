#!/usr/bin/expect --

if {$argc < 3} {
    puts "$argv0: not enough arguments\n"
    puts "Usage:  $argv0 smtp_server fromaddr toaddr \[-tls\]"
    exit
}

set helo [exec hostname]
set endpt [split [lrange $argv 0 0] ":"]
set host [lindex $endpt 0]
set port [lindex $endpt 1]
set fromaddr [lrange $argv 1 1]
set toaddr [lrange $argv 2 2]
set tls [lrange $argv 3 3]
set oks 1

if {$port == ""} {
    set port 25
}

puts "client hostname: $helo"
puts "server: $host:$port"
puts "FROM address: $fromaddr"
puts "RCPT TO address: $toaddr"
puts "-----------------------\n"

if {$tls == ""} {
    spawn nc -v $host $port
} else {
    spawn openssl s_client -verify_quiet -connect $host:$port -starttls smtp -name $helo -crlf -quiet
    expect {
        "250 " {
            send "EHLO $helo\n"
        }
    }
}

expect {
    "220" {
        send "EHLO $helo\n"
        exp_continue
    }
    "250 " {
        switch $oks {
            1 {
                send "MAIL FROM:<$fromaddr>\n"
                set oks 2
                exp_continue
            }
            2 {
                send "RCPT TO:<$toaddr>\n"
                set oks 3
                exp_continue
            }
            3 {
                send "QUIT\n"
                exit
            }
        }
    }
    "550 " {
        send "QUIT\n"
        exit
    }
}
